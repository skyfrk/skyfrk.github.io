{"componentChunkName":"component---src-templates-blog-post-jsx","path":"/blog/2019/connecting-the-digital-worlds-3/","result":{"data":{"markdownRemark":{"html":"<p>In the <a href=\"/blog/2019/connecting-the-digital-worlds-2\">previous article</a> we implemented the flow of events from IFTTT to tapio-ready machines. Now we want to implement forwarding events from tapio-ready machines to IFTTT.</p>\n<p>This article was originally written for <a href=\"https://www.tapio.one/\">tapio</a>. You can read it <a href=\"https://www.tapio.one/en/blog/connecting-the-digital-worlds-part-3\">here</a>.</p>\n<ul>\n<li><a href=\"/blog/2019/connecting-the-digital-worlds-1\">Connecting the digital worlds (1/3)</a></li>\n<li><a href=\"/blog/2019/connecting-the-digital-worlds-2\">Connecting the digital worlds (2/3)</a></li>\n<li><a href=\"/blog/2019/connecting-the-digital-worlds-3\">Connecting the digital worlds (3/3)</a></li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c12f4d5be71f671057f1caf1d692af5f/a0730/tapio-ifttt-sequence-from-machine.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAABV0lEQVQY0yWM3UvCUADF7+xF8bXHCsL/sghCRKbOL+ghqEQD6w/oJQoCSZepFZJsujkxP/BzOtnd1vVu93all8M5nPM7QO99GyNp1BFHcmM9bs2Uz4Vce5Yfz/r5k34+PbxLyfmwkjsdFLLD+6h22+yWl9rHRP2a95pgs5wbi6m5mkNzDU3d0GcU2pd6aX8TO7TSITMdsjJHduaAeZg5NpLllUQtCKFhbnRAkEsp3dpo+4tcZ2ssV9ShKSgCHNmjSUATgCQAFTgqMM/hmIgGbO8SjxICPIRZIB75VxtaDBb0EjDOfSjOobjP5gGOcezCZTEmOj/U28GEwQQhRjFup9RDjs26C+cd4KifpAIkGYR8APJ+LARxMugkqrBHLeRYkGIMZu3aVKlP1cq0U5+o1UHzdSlXX5oPfDsXVm6u1eKVVhS6hYiay2nFrJRvtJ4W6ttYqg6+K3+mwBcABpsi6gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Sequence diagram\"\n        title=\"Sequence diagram\"\n        src=\"/static/c12f4d5be71f671057f1caf1d692af5f/5a190/tapio-ifttt-sequence-from-machine.png\"\n        srcset=\"/static/c12f4d5be71f671057f1caf1d692af5f/772e8/tapio-ifttt-sequence-from-machine.png 200w,\n/static/c12f4d5be71f671057f1caf1d692af5f/e17e5/tapio-ifttt-sequence-from-machine.png 400w,\n/static/c12f4d5be71f671057f1caf1d692af5f/5a190/tapio-ifttt-sequence-from-machine.png 800w,\n/static/c12f4d5be71f671057f1caf1d692af5f/a0730/tapio-ifttt-sequence-from-machine.png 1131w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>First off we need a way to trigger an event on our demo machine. We decided to go with a <a href=\"https://www.sunrom.com/p/micro-pir-motion-detection-sensor-am312\">AM312</a> <a href=\"https://en.wikipedia.org/wiki/Passive_infrared_sensor\">PIR</a> motion sensor which can be directly connected to the demo machine through its <a href=\"https://www.raspberrypi.org/documentation/usage/gpio/\">GPIO interface</a>. When properly connected to a ground pin, a voltage pin and a generic GPIO data pin it'll output a current on the GPIO pin when there is motion in front of it.</p>\n<p>Now that our sensor is ready we have to monitor it for status changes in order to react to motion events. Microsofts GPIO library <a href=\"https://github.com/dotnet/iot\">System.Device.Gpio</a> provides a method <code class=\"language-text\">RegisterCallbackForPinValueChangedEvent</code> through which one can subscribe to rising or falling currents. Using this method we wrote a little wrapper to simplify things a bit:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MotionSensorMonitor</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IMotionSensorMonitor</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> _Pin<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">event</span> <span class=\"token class-name\">EventHandler</span> OnMotion<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">MotionSensorMonitor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">int</span></span> pinBoardNumber<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _Pin <span class=\"token operator\">=</span> pinBoardNumber<span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> controller <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">GpioController</span><span class=\"token punctuation\">(</span>PinNumberingScheme<span class=\"token punctuation\">.</span>Board<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        controller<span class=\"token punctuation\">.</span><span class=\"token function\">OpenPin</span><span class=\"token punctuation\">(</span>_Pin<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        controller<span class=\"token punctuation\">.</span><span class=\"token function\">SetPinMode</span><span class=\"token punctuation\">(</span>_Pin<span class=\"token punctuation\">,</span> PinMode<span class=\"token punctuation\">.</span>Input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        controller<span class=\"token punctuation\">.</span><span class=\"token function\">RegisterCallbackForPinValueChangedEvent</span><span class=\"token punctuation\">(</span>_Pin<span class=\"token punctuation\">,</span> PinEventTypes<span class=\"token punctuation\">.</span>Rising<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n        <span class=\"token punctuation\">{</span>\n            OnMotion<span class=\"token punctuation\">?.</span><span class=\"token function\">Invoke</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">EventArgs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now that we're able to react to status changes we want them reflected in the OPC UA server of our demo machine so that these changes can get forwarded to tapio through the CloudConnector also running on our demo machine. So we have to a add a node to our OPC UA servers address space:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">protected</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">CreateAddressSpace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">base</span><span class=\"token punctuation\">.</span><span class=\"token function\">CreateAddressSpace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    _MotionSensorState <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">DataVariableState<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"MotionSensorState\"</span><span class=\"token punctuation\">,</span> RootFolder<span class=\"token punctuation\">,</span> SystemContextObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">AddNode</span><span class=\"token punctuation\">(</span>_MotionSensorState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then we have to add a method to our node manager which updates our <code class=\"language-text\">MotionSensorState</code> node when called:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">OnMotionDetected</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>_MotionSensorState <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">InvalidOperationException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Please create the base event state first\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    _MotionSensorState<span class=\"token punctuation\">.</span><span class=\"token function\">StatusChanged</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"motiondetected\"</span><span class=\"token punctuation\">,</span> StatusCodes<span class=\"token punctuation\">.</span>Good<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Finally we have to hook up the motion sensor monitor with our event handler method:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> args<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> led <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Led</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span> <span class=\"token number\">21</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> ledController <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">LedController</span><span class=\"token punctuation\">(</span>led<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> motionSensorMonitor <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">MotionSensorMonitor</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> nodeManager <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NodeManager</span><span class=\"token punctuation\">(</span>ledController<span class=\"token punctuation\">,</span> motionSensorMonitor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> server <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Server</span><span class=\"token punctuation\">(</span>nodeManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    motionSensorMonitor<span class=\"token punctuation\">.</span>OnMotion <span class=\"token operator\">+=</span> nodeManager<span class=\"token punctuation\">.</span>OnMotionDetected<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we're able to reflect motions in front of our PIR motion sensor to OPC UA node status changes. CloudConnector can forward these status changes to tapio if we configure the data module of the CloudConnector <a href=\"https://developer.tapio.one/docs/CloudConnector/DataModule.html#sourcedataitem\">correctly</a>. Keep the configured <code class=\"language-text\">SrcKey</code> in mind.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\">...\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>SourceItem</span> <span class=\"token attr-name\"><span class=\"token namespace\">xsi:</span>type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>SourceDataItem<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>NodeId</span><span class=\"token punctuation\">></span></span>ns=2;s=PiSensorServer.MotionSensorState<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>NodeId</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>SrcKey</span><span class=\"token punctuation\">></span></span>MotionSensorState<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>SrcKey</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>SourceItem</span><span class=\"token punctuation\">></span></span>\n...</code></pre></div>\n<p>As tapio <a href=\"https://developer.tapio.one/docs/TapioDataCategories.html#streaming-data\">supports</a> streaming this data into an <a href=\"https://azure.microsoft.com/en-in/services/event-hubs/\">Azure Event Hub</a> we deployed us one through the <a href=\"http://portal.azure.com/\">Azure Portal</a> and configured an app in <a href=\"https://my.tapio.one/\">my tapio</a> to forward the data to our event hub.</p>\n<p>Data ingested into an Azure Event Hub can easily be processed, stored or served for third party apps. As we only want to process and forward events as they come in we opted for a serverless approach <a href=\"/blog/2019/connecting-the-digital-worlds-2\">again</a> with another Azure Function hooked up to our event hub.</p>\n<p>Below we can see how an event message ingested into our event hub looks like:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"tmid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"741ab3a2-040a-44bf-b8ce-4333d567a99a\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// machine id</span>\n  <span class=\"token property\">\"msgid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"bf8610fa-a5e9-4ede-ad37-51082e7eb372\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// message id</span>\n  <span class=\"token property\">\"msgt\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"itd\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// message type</span>\n  <span class=\"token property\">\"msgts\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2017-06-29T10:39:03.7651013+01:00\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ISO8601 timestamp</span>\n  <span class=\"token property\">\"msg\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"p\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"pi\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// provider name</span>\n    <span class=\"token property\">\"k\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"MotionSensorState\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// key, usually the node id</span>\n    <span class=\"token property\">\"vt\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"s\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// data value type (string)</span>\n    <span class=\"token property\">\"v\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"motiondetected\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// payload</span>\n    <span class=\"token property\">\"q\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"g\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// quality of the value (OPC UA thing)</span>\n    <span class=\"token property\">\"sts\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2017-06-29T10:38:43.7606016+01:00\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ISO8601 timestamp by OPC UA server</span>\n    <span class=\"token property\">\"rts\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2017-06-29T10:38:53.7606016+01:00\"</span> <span class=\"token comment\">// ISO8601 timestamp by CloudConnector</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a href=\"https://developer.tapio.one/docs/TapioDataCategories.html#streaming-data\">Streaming data</a> messages from tapio received by our event hub can have different structures. We're only interested into <a href=\"https://developer.tapio.one/docs/TapioDataCategories.html#item-data\">item data</a> messages because we just want to monitor status changes of our PIR motion sensor monitor node. We can recognize an item data message if we take a look at the <code class=\"language-text\">msgt</code> (message type) key. Every item data message has the type <code class=\"language-text\">itd</code>.</p>\n<p>The property <code class=\"language-text\">msg</code> stores the actual item data message as JSON object. Here we're looking for messages with their <code class=\"language-text\">k</code> (key) being the previously configured <code class=\"language-text\">SrcKey</code>. The value we're forwarding hides behind the <code class=\"language-text\">v</code> key. Once again to keep things simple this is only a string (<code class=\"language-text\">motiondetected</code>) but it could be any complex event object when serialized as JSON object for example.</p>\n<p>Below we can see a simplified version of our event hub processor Azure Function:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">FunctionName</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"EventHubProcessorFunction\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">IoTHubTrigger</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"ifttt\"</span><span class=\"token punctuation\">,</span> Connection <span class=\"token operator\">=</span> <span class=\"token string\">\"EventHubConnection\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span><span class=\"token class-name\">EventData</span> message<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Microsoft<span class=\"token punctuation\">.</span>Azure<span class=\"token punctuation\">.</span>WebJobs<span class=\"token punctuation\">.</span>ExecutionContext</span> context<span class=\"token punctuation\">,</span>\n<span class=\"token class-name\">CancellationToken</span> cancellationToken<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> streamingDataMessage <span class=\"token operator\">=</span> JsonConvert<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">DeserializeObject</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>StreamingDataMessage<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>Encoding<span class=\"token punctuation\">.</span>UTF8<span class=\"token punctuation\">.</span><span class=\"token function\">GetString</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">.</span>Array<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>streamingDataMessage<span class=\"token punctuation\">.</span>MessageType <span class=\"token operator\">!=</span> <span class=\"token string\">\"itd\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> itemDataMessage <span class=\"token operator\">=</span> JsonConvert<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">DeserializeObject</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>ItemDataMessage<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>streamingDataMessage<span class=\"token punctuation\">.</span>Message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>itemDataMessage<span class=\"token punctuation\">.</span>SrcKey <span class=\"token operator\">!=</span> <span class=\"token string\">\"MotionSensorState\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">await</span> <span class=\"token function\">SendEventToIFTTT</span><span class=\"token punctuation\">(</span>itemDataMessage<span class=\"token punctuation\">.</span>Value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In similar fashion to our <a href=\"/blog/2019/connecting-the-digital-worlds-2\">other Azure Function</a> we're simply consuming messages from our event hub and then forward them to IFTTT. The <code class=\"language-text\">SendEventToIFTTT</code> method wraps a simple HTTP request towards the IFTTT Webhook service:</p>\n<p>POST <code class=\"language-text\">https://maker.ifttt.com/trigger/&lt;name of the event&gt;/with/key/&lt;your accounts webhook service key&gt;</code></p>\n<p>The Webhook service key can be obtained <a href=\"https://ifttt.com/maker_webhooks\">here</a> (if you're logged in). The Webhook service is also able to interpret an <code class=\"language-text\">application/json</code> body if it has the structure below:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"value1\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"some string\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"value2\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"#MWIGA\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"value3\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"hello world\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Taking advantage of the body structure one could transmit any kind of event data to IFTTT. Finally we have to configure an applet in IFTTT to test our implementation. We combined <a href=\"https://ifttt.com/services/google_sheets\">Google Sheets</a> with the Webhook service for example:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 800px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5a1bf19e8e4c7fbabb54389720cc49b9/97655/receiving-applet-config.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 446%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Receiving applet config\"\n        title=\"Receiving applet config\"\n        src=\"/static/5a1bf19e8e4c7fbabb54389720cc49b9/5a190/receiving-applet-config.png\"\n        srcset=\"/static/5a1bf19e8e4c7fbabb54389720cc49b9/772e8/receiving-applet-config.png 200w,\n/static/5a1bf19e8e4c7fbabb54389720cc49b9/e17e5/receiving-applet-config.png 400w,\n/static/5a1bf19e8e4c7fbabb54389720cc49b9/5a190/receiving-applet-config.png 800w,\n/static/5a1bf19e8e4c7fbabb54389720cc49b9/97655/receiving-applet-config.png 819w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Conclusion</h2>\n<p>That's it! Two Azure Functions, an Event Hub, a Raspberry Pi and three workdays later we were able to present a functioning prototype. For our demo on day four we logged motion sensor data through our tapio-IFTTT-Connector into a Google Drive sheet, turned on a RGB LED with the press of a widget button on a smartphone and configured a new IFTTT-Applet live. We didn't develop a shippable product but built a working proof of concept in the tapio ecosystem which can be transformed into a proper solution. Authentication, authorization and a web interface for configuring events are mandatory for a feature complete solution and our code base also lacks a huge refactoring... :D</p>\n<p>But aside from resolving the actual challenges <a href=\"https://www.tapio.one/en/blog/hack-the-wood-2019\">#hackthewood2019</a> was most notably a fun event with awesome attendees who helped each other out at any time and had a great time together in Berlin!</p>","frontmatter":{"title":"Connecting the digital worlds (3/3)","date":"July 16th, 2019","author":"Simon Eßlinger"},"excerpt":"In the previous article we implemented the flow of events from IFTTT to tapio-ready machines. Now we want to implement forwarding events…","timeToRead":7}},"pageContext":{"slug":"/blog/2019/connecting-the-digital-worlds-3/"}}}